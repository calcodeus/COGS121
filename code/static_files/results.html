<!--

Web frontend for petsapp

COGS121 by Philip Guo
https://github.com/pgbovine/COGS121

Start ../server.js and then visit this URL to view this webpage:

http://localhost:3000/petsapp.html

-->

<html>

<head>
  <title>Anime Noobs</title>
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->



  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">
  <script src="jquery-3.3.1.min.js"></script>

  <link rel="stylesheet" href="css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">

  <script src="jquery-3.3.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>

  <script type="text/javascript">
    let favorites = {};
    let keywordList = {};
    let genreList = {};
    let recList = [];

    function recFor(type, id) {
      const requestURL = 'recommend/' + type + '/' + id;
      console.log('making ajax request to:', requestURL);
      return $.get(requestURL);
    }


    function displayRecs(recList) {
      let resultsField = '';
      recList.forEach((d) => {
        const name = d.title;
        console.log(name);
        const poster = d.poster_path
        console.log(poster);

        const pre = '<img class="poster" src=http://image.tmdb.org/t/p/w185/';
        const mid = ' alt=""><a href="mediaPage.html">'
        const post = '</a><br>'

        resultsField += pre + poster + mid + name + post;

      });
      $('#results').html(resultsField);
    }

    function keywordSearch() {
      const defList = [];
      Object.keys(keywordList).forEach((k) => {
        console.log(k);
        defList.push(recFor('Keyword', k));
      });
      Object.keys(genreList).forEach((g) => {
        console.log(g);
        defList.push(recFor('Genre', g));
      });
      return defList;
    }

    function fakeRecs() {
      let i = 0;
      while (i < 30) {
        i = i + 1;
        if (i >= Object.keys(favorites).length) {
          console.log('not enough favorites!');
          break;
        }
        favorites[Object.keys(favorites)[i]].keyword_ids.forEach((kid) => {

          const requestURL = 'recommend/Keyword/' + kid;
          console.log('hitting: ' + requestURL);
          $.get(requestURL, (data) => {
            if (data != []) {
              console.log(data);
            }
            data.forEach((d) => {
              const getMovieURL = 'getMovie/' + d;
              $.get(getMovieURL, (title) => {
                let resultsField = '';

                recList.push(title);
                sessionStorage.recList = JSON.stringify(recList);
                const loc = recList.length - 1;

                const name = title.title;
                console.log(name);
                const poster = title.poster_path;
                const pre = '<div class="col-sm-4" style="text-align:center; padding-bottom: 30px;"><img class="poster" src=http://image.tmdb.org/t/p/w185/';
                const mid = ' alt=""><br><a href="mediaPage.html#' + loc + '">';
                const post = '</a></div><br>';
                resultsField += pre + poster + mid + name + post;
                let resultDiv = document.getElementById('results');

                resultDiv.insertAdjacentHTML('beforeend', resultsField);

              });
            });
          });
        });
      }
    }

    function LoadRecs() {
      console.dir(Object.keys(keywordList));
      console.dir(Object.keys(genreList));
      var defList = keywordSearch();
      $.when.apply(this, defList).then((results) => {
        console.log(results);
      });
    }

    function SetupLists(favs) {
      console.log(typeof favs);
      Object.keys(favs).forEach((fv) => {
        console.log(favs[fv]);
        favs[fv].genre_ids.forEach((gi) => {
          const gscore = genreList[gi];
          if (!gscore) {
            genreList[gi] = 1;
          } else {
            genreList[gi] = gscore + 1;
          }
        });
        favs[fv].keyword_ids.forEach((ki) => {
          const kscore = keywordList[ki];
          if (!kscore) {
            keywordList[ki] = 1;
          } else {
            keywordList[ki] = kscore + 1;
          }
        });
      });
    }

    // jQuery convention for running when the document has been fully loaded:
    $(document).ready(() => {
      favorites = JSON.parse(localStorage.favorites);
      console.log('favorites: ');
      console.log(typeof favorites);
      console.dir(favorites);
      SetupLists(favorites);
      fakeRecs();
      //LoadRecs();
      $('#next').click(() => {
        //LoadRecs();
      });
      $('#previous').click(() => {
        //LoadRecs();
      });

      // define a generic Ajax error handler:
      // http://api.jquery.com/ajaxerror/
      $(document).ajaxError(() => {
        $('#status').html('Error: unknown ajaxError!');
      });
    });
  </script>
  <style>
    #page {
      max-margin-left: 20%;
      max-margin-right: 20%;
    }

    .slider {
      -webkit-appearance: none;
      width: 20%;
      height: 15px;
      border-radius: 5px;
      background: #d3d3d3;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
    }

    .poster {
      height: 20vh;
    }

    #ratingContainer {
      margin-left: 40px;
      margin-right: 40px;
    }
  </style>
</head>

<body class="container">
  <center style="padding-top: 3vh;">
    <a href="homepage.html">
      <button><i class="fas fa-home"></i></button>
    </a>
    <a href="favorites.html">
      <button><i class="fas fa-star"></i></button>
    </a>
  </center>

  <div id="page" style="padding-top: 3vh;">
    <center>
      <h1>Recommendations</h1>
    </center>
    <hr>

    <div id="results">

    </div>


    <center>
      <div class="slidecontainer">
        Action <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
        <button id="delete"><i class="fas fa-times"></i></button>
      </div>
    </center>
  </div>
</body>

</html>
