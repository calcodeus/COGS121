<!--

Web frontend for petsapp

COGS121 by Philip Guo
https://github.com/pgbovine/COGS121

Start ../server.js and then visit this URL to view this webpage:

http://localhost:3000/petsapp.html

-->

<html>

<head>
  <title>Anime Noobs</title>
  <!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"> -->



  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.10/css/all.css" integrity="sha384-+d0P83n9kaQMCwj8F4RJB66tzIwOKmrdb46+porD/OvrJ+37WqIM7UoBtwHO6Nlg" crossorigin="anonymous">
  <script src="jquery-3.3.1.min.js"></script>

  <link rel="stylesheet" href="css/bootstrap-grid.min.css">
  <link rel="stylesheet" href="css/bootstrap-reboot.min.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">

  <script src="jquery-3.3.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>

  <!-- wine and cheese links  -->
  <link href="font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="bootstrap-3.3.7-dist/css/bootstrap.min.css">
  <link href="style.css" rel="stylesheet">
  <link rel="shortcut icon" type="image/png" href="icon.png">
  <!-- end wine and cheese notes  -->

  <script type="text/javascript">
    let favorites = {};
    let keywordList = {};
    let genreList = {};
    let recommendations = {};

    function recFor(type, id) {
      const requestURL = 'recommend/' + type + '/' + id;
      console.log('making ajax request to:', requestURL);
      return $.get(requestURL);
    }


    function keywordSearch() {
      const defList = [];
      Object.keys(keywordList).forEach((k) => {
        console.log(k);
        defList.push(recFor('Keyword', k));
      });
      Object.keys(genreList).forEach((g) => {
        console.log(g);
        defList.push(recFor('Genre', g));
      });
      return defList;
    }

    function fakeRecs() {
      let i = 0;
      while (i < 30) {
        i = i + 1;
        if (i >= Object.keys(favorites).length) {
          console.log('not enough favorites!');
          break;
        }
        favorites[Object.keys(favorites)[i]].keyword_ids.forEach((kid) => {

          const requestURL = 'recommend/Keyword/' + kid;
          //console.log('hitting: ' + requestURL);
          $.get(requestURL, (data) => {
            if (data != []) {
              //console.log(data);
            }
            data.forEach((d) => {
              const getMovieURL = 'getMovie/' + d;
              const recList = [];
              $.get(getMovieURL, (title) => {
                if (!recommendations[title.id]) {
                  recommendations[title.id] = title;
                  recList.push(title);
                  sessionStorage.recList = JSON.stringify(recList);
                  const loc = recList.length - 1;
                  DisplayRec(title, loc);
                }
              });
            });
          });
        });
      }
    }

    function DisplayRec(title, number) {
      let resultsField = '';
      const name = title.title;
      //console.log(name);
      const poster = title.poster_path;
      const pre = '<div class="col-sm-4" style="text-align:center; padding-bottom: 30px;"><img class="poster" src=http://image.tmdb.org/t/p/w185/';
      const mid = ' alt=""><br><a href="mediaPage.html#' + number + '">';
      const post = '</a></div><br>';
      resultsField += pre + poster + mid + name + post;
      let resultDiv = document.getElementById('results');

      resultDiv.insertAdjacentHTML('beforeend', resultsField);
    }

    function LoadRecs() {
      console.dir(Object.keys(keywordList));
      console.dir(Object.keys(genreList));
      var defList = keywordSearch();
      $.when.apply(this, defList).then((results) => {
        console.log(results);
      });
    }

    function SetupLists(favs) {
      console.log(typeof favs);
      Object.keys(favs).forEach((fv) => {
        //console.log(favs[fv]);
        favs[fv].genre_ids.forEach((gi) => {
          if (!genreList[gi]) {
            genreList[gi] = {}
          }
          const gscore = genreList[gi].score;
          if (!gscore) {
            genreList[gi].score = 1;
          } else {
            genreList[gi].score = gscore + 1;
          }
          if (!genreList[gi].basis) {
            genreList[gi].basis = [fv];
          } else {
            genreList[gi].basis.push(fv);
          }
        });
        favs[fv].keyword_ids.forEach((ki) => {
          if (!keywordList[ki]) {
            keywordList[ki] = {}
          }
          const kscore = keywordList[ki].score;
          if (!kscore) {
            keywordList[ki].score = 1;
          } else {
            keywordList[ki].score = kscore + 1;
          }
          if (!keywordList[ki].basis) {
            keywordList[ki].basis = [fv];
          } else {
            keywordList[ki].basis.push(fv);
          }
        });
      });
      console.dir(keywordList);
      console.dir(genreList);
    }

    // jQuery convention for running when the document has been fully loaded:
    $(document).ready(() => {
      favorites = JSON.parse(localStorage.favorites);
      //console.log('favorites: ');
      //console.log(typeof favorites);
      //console.dir(favorites);
      SetupLists(favorites);
      fakeRecs();
      //LoadRecs();
      $('#next').click(() => {
        //LoadRecs();
      });
      $('#previous').click(() => {
        //LoadRecs();
      });

      // define a generic Ajax error handler:
      // http://api.jquery.com/ajaxerror/
      $(document).ajaxError(() => {
        $('#status').html('Error: unknown ajaxError!');
      });
    });
  </script>
  <style>
    #page {
      max-margin-left: 20%;
      max-margin-right: 20%;
    }

    .slider {
      -webkit-appearance: none;
      width: 20%;
      height: 15px;
      border-radius: 5px;
      background: #d3d3d3;
      outline: none;
      opacity: 0.7;
      -webkit-transition: .2s;
      transition: opacity .2s;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
    }

    .slider::-moz-range-thumb {
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #4CAF50;
      cursor: pointer;
    }

    .poster {
      height: 20vh;
    }

    #ratingContainer {
      margin-left: 40px;
      margin-right: 40px;
    }
  </style>
</head>

<body>
  <center style="padding-top: 3vh;">
    <a href="homepage.html">
      <button><i class="fas fa-home"></i></button>
    </a>
    <a href="favorites.html">
      <button><i class="fas fa-star"></i></button>
    </a>
  </center>

  <!-- <div id="results"> -->

  <div id="cy"></div>
  <div id="loading">
    <span class="fa fa-refresh fa-spin"></span>
  </div>

  <!-- <div id="search-wrapper">
    <input type="text" class="form-control" id="search" placeholder="&#xf002; Search">
  </div> -->

  <!-- <center style="z-index: 9999; position: absolute;">
    <a href="homepage.html">
      <button style="width: 3em;margin: 0.5em;"><i class="fas fa-home"></i></button>
    </a>
    <a href="favorites.html">
      <button style="width: 3em;margin: 0.5em;"><i class="fas fa-star"></i></button>
    </a>
  </center> -->

  <!-- details box that appears when you click on a node -->
  <div id="info">,
  </div>

  <script src="fastclick.min.js"></script>
  <script src="jquery.min.js"></script>

  <script src="cytoscape.min.js"></script>

  <script src="jquery.qtip.min.js"></script>
  <link href="jquery.qtip.min.css" rel="stylesheet" type="text/css" />
  <script src="cytoscape-qtip.js"></script>

  <script src="bluebird.min.js"></script>
  <script src="bootstrap.min.js"></script>
  <script src="typeahead.bundle.js"></script>
  <script src="handlebars.min.js"></script>
  <script src="lodash.min.js"></script>

  <script src="demo.js"></script>

  <center style="position: absolute; left: 50%; top: -1.5%;">
    <h1 style="color: #fff; position: relative; left: -50%; z-index: 9999;">Recommendations</h1>
    <a href="homepage.html">
      <button class="btn btn-default"style="width: 3em;margin: 0.5em; position: relative;left: -50%;padding: 6px 12px; color: #000"><i class="fas fa-home"></i></button>
    </a>
    <a href="favorites.html">
      <button class="btn btn-default"style="width: 3em;margin: 0.5em;position: relative;left: -50%; padding: 6px 12px; color: #000"><i class="fas fa-star"></i></button>
    </a>
  </center>

  <button id="reset" class="btn btn-default"><i class="fa fa-arrows-h"></i></button>

  <script>
    (function(i, s, o, g, r, a, m) {
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function() {
        (i[r].q = i[r].q || []).push(arguments)
      }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-155159-12', 'auto');
    ga('send', 'pageview');
  </script>




  <!-- <center>
    <div class="slidecontainer">
      Action <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
      <button id="delete"><i class="fas fa-times"></i></button>
    </div>
  </center> -->
  </div>
</body>

</html>